---
title: ğŸŒˆè¶…æ—¶ä»»åŠ¡
date: 2020-05-11 13:54:56
permalink: /pages/2f8gmn
article: false
---
## è¶…æ—¶ä»»åŠ¡

**ä½•è¶…æ—¶ä»»åŠ¡ï¼Ÿ** é¡¾åæ€ä¹‰å…¶å®å°±æ˜¯å•ä¸€ä»»åŠ¡å¯ä»¥é€šè¿‡è®¾ç½®è¶…æ—¶æ—¶é—´å†³å®šæ”¹ä»»åŠ¡æ˜¯å¦ç»§ç»­æ‰§è¡Œã€‚é…ç½®æ–¹å¼å¾ˆç®€å•ã€‚å¦‚ä¸‹æ“ä½œï¼š

**æ³¨è§£é…ç½®**
ä½¿ç”¨ <code>@Task</code>æ³¨è§£ä¸­çš„ <code>timeoutInMilliseconds</code> å±æ€§è¿›è¡Œé…ç½®ã€‚
* timeoutInMilliseconds å›ºå®šä½¿ç”¨æ¯«ç§’æ•°
```java 
package com.gobrs.async.test.task.timeout;
import com.gobrs.async.core.TaskSupport;
import com.gobrs.async.core.anno.Task;
import com.gobrs.async.core.task.AsyncTask;
import lombok.SneakyThrows;
import lombok.extern.slf4j.Slf4j;

/**
 * The type A service.
 * @program: gobrs -async-starter
 * @description:
 * @author: sizegang
 */
@Slf4j
@Task(timeoutInMilliseconds = 300)
public class CaseTimeoutTaskA extends AsyncTask {

    /**
     * The .
     */
    int i = 10000;

    @Override
    public void prepare(Object o) {
        log.info(this.getName() + " ä½¿ç”¨çº¿ç¨‹---" + Thread.currentThread().getName());
    }

    @SneakyThrows
    @Override
    public String task(Object o, TaskSupport support) {
        System.out.println("CaseTimeoutTaskA Begin");
        Thread.sleep(400);
        for (int i1 = 0; i1 < i; i1++) {
            i1 += i1;
        }
        System.out.println("CaseTimeoutTaskA Finish");
        return "result";
    }

    @Override
    public boolean necessary(Object o, TaskSupport support) {
        return true;
    }

    @Override
    public void onSuccess(TaskSupport support) {
    }
}

```

## è¶…æ—¶ç›‘å¬çº¿ç¨‹æ± é…ç½®
**æ‰€è°“çš„ç›‘å¬çº¿ç¨‹æ± é…ç½®å³ï¼šç›‘å¬ä»»åŠ¡è¶…æ—¶çš„çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå…³äºä¸ºä»€ä¹ˆè¦é…ç½®è¯¥å‚æ•°ã€‚è¯·æŸ¥çœ‹ä¸‹æ–¹çš„[åŸç†åˆ†æ](#ç‰¹åˆ«è¯´æ˜)ã€‚**
```yaml
gobrs:
  async:
    config:
      rules:
        - name: "chain1"
          content: "taskA->taskB->taskC"
      timeout-core-size: 200 # æ ¸å¿ƒçº¿ç¨‹æ•°é‡
```

**å¦‚æœä¸é…ç½®åˆ™å–é»˜è®¤å€¼ï¼Œé»˜è®¤å€¼è®¡ç®—æ–¹å¼å¦‚ä¸‹ï¼š**
```java 
    public static Integer calculateCoreNum() {
        int cpuCoreNum = Runtime.getRuntime().availableProcessors();
        return new BigDecimal(cpuCoreNum).divide(new BigDecimal("0.2")).intValue();
    }
```

## å•ä¾‹æµ‹è¯•
[è¿è¡Œä»£ç ](https://gitee.com/dromara/gobrs-async/blob/master/gobrs-async-test/src/test/java/com/gobrs/async/test/timeout/CaseTimeout.java)

## è¿è¡Œç»“æœ
```sh  
2022-12-09 16:51:41.031  INFO 37083 --- [pool-2-thread-1] c.g.a.t.task.timeout.CaseTimeoutTaskA    : caseTimeoutTaskA ä½¿ç”¨çº¿ç¨‹---pool-2-thread-1
CaseTimeoutTaskA Begin
2022-12-09 16:51:41.355 ERROR 37083 --- [   GobrsTimer-1] com.gobrs.async.core.timer.GobrsTimer    : 

com.gobrs.async.core.common.exception.TimeoutException: task caseTimeoutTaskA TimeoutException
	at com.gobrs.async.core.TaskLoader$1.tick(TaskLoader.java:394) ~[classes/:na]
	at com.gobrs.async.core.timer.GobrsTimer.lambda$addTimerListener$0(GobrsTimer.java:80) ~[classes/:na]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_251]
	at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308) ~[na:1.8.0_251]
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180) ~[na:1.8.0_251]
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294) ~[na:1.8.0_251]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) ~[na:1.8.0_251]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) ~[na:1.8.0_251]
	at java.lang.Thread.run(Thread.java:748) ~[na:1.8.0_251]

2022-12-09 16:51:41.375  INFO 37083 --- [pool-2-thread-2] c.g.a.t.task.timeout.CaseTimeoutTaskB    : caseTimeoutTaskB ä½¿ç”¨çº¿ç¨‹---pool-2-thread-2
CaseTimeoutTaskB Begin
CaseTimeoutTaskB Finish
2022-12-09 16:51:41.377  INFO 37083 --- [pool-2-thread-2] c.g.a.t.task.timeout.CaseTimeoutTaskC    : caseTimeoutTaskC ä½¿ç”¨çº¿ç¨‹---pool-2-thread-2
CaseTimeoutTaskC Begin
CaseTimeoutTaskC Finish
2022-12-09 16:51:43.426  INFO 37083 --- [           main] com.gobrs.async.core.TaskLoader          : ã€ProcessTraceã€‘Total cost: 2413msã€taskã€‘caseTimeoutTaskA cost :312msã€stateã€‘ï¼šfailã€errMsgã€‘: sleep interrupted; ->ã€taskã€‘caseTimeoutTaskB cost :0msã€stateã€‘ï¼šsuccess; ->ã€taskã€‘caseTimeoutTaskC cost :2011msã€stateã€‘ï¼šsuccess; 

```

## ç‰¹åˆ«è¯´æ˜
* è¶…æ—¶ä»»åŠ¡ä¸æ”¯æŒçº¿ç¨‹å¤ç”¨ï¼Œå› ä¸ºéœ€è¦é€šè¿‡æ§åˆ¶çº¿ç¨‹è¶…æ—¶æ¥è¿›è¡Œé€»è¾‘åˆ¤æ–­ï¼Œå¦‚æœæ”¯æŒçº¿ç¨‹å¤ç”¨ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸­æ–­æ­£åœ¨å¤ç”¨çº¿ç¨‹çš„ä»»åŠ¡æ‰§è¡Œã€‚
* ç†”æ–­é™çº§åŸç†å€Ÿé‰´`Hystrix` æ–¹å¼å¤„ç†ï¼Œå¦‚æœå¯¹`Hystrix`ä¸ç†Ÿæ‚‰å¯ä»¥å€Ÿé‰´ [Hystrix ç†”æ–­é™çº§åŸç†è§£æ](https://my.oschina.net/13426421702/blog/3071368)
* å› çº¿ç¨‹è°ƒåº¦çš„åŸå› ï¼Œè¶…æ—¶æ—¶é—´å¯èƒ½å­˜åœ¨10mså†…çš„è¯¯å·®ï¼Œå¯å¿½ç•¥ï¼
