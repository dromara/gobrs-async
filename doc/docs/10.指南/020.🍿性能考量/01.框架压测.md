---
title: ğŸæ¡†æ¶å‹æµ‹
date: 2021-05-11 13:59:38
rightMenuBar: false
article: false
permalink: /pages/771df6/
---

## å‹æµ‹ç¯å¢ƒ

## å‹æµ‹èƒŒæ™¯
**ç°åœ¨æœ‰ä¸€ç§åœºæ™¯è°ƒç”¨é“¾è·¯å¦‚ä¸‹ï¼š**
AService (æ‰§è¡Œæ¶ˆè€—1000ms) è°ƒç”¨ BService  (æ‰§è¡Œæ¶ˆè€—500ms)ã€‚

EService  (æ‰§è¡Œæ¶ˆè€—500ms) è°ƒç”¨ FService  (æ‰§è¡Œæ¶ˆè€—1000ms)
 
å³ï¼š `AService->BService; EService->FService;`
### JVMå‚æ•°
```sh 
-Xmx6g -Xms6g -Xmn4g
```
### Jemeter å‹æµ‹
å¹¶å‘å¾ªç¯å‹æµ‹ ä¸€ç§’ 300æ¬¡è®¿é—®

![å‹æµ‹é…ç½®](https://kevin-cloud-dubbo.oss-cn-beijing.aliyuncs.com/gobrs-async/yace-gobrs.jpg)

## åˆ›å»ºå¼‚æ­¥ä»»åŠ¡


**åˆ›å»ºAService**

AService ä»»åŠ¡æ¨¡æ‹ŸHttpè°ƒç”¨ï¼Œä»»åŠ¡æµç¨‹æ¶ˆè€— 1000ms

```java
@Service
public class AService implements AsyncTask<DataContext, DataContext>, ParaExector {
    @Override
    public void callback(boolean success, DataContext param, TaskResult<DataContext> workResult) {
        if (success) {
            System.out.println("AService æˆåŠŸ");
        } else {
            System.out.println("AService å¤±è´¥");
        }
    }
    @Override
    public DataContext task(DataContext params, GobrsAsyncSupport support) {
        try {
            Thread.sleep(1000);
            System.out.println("AService æ‰§è¡Œå®Œäº†");

        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        byte[] result  = new byte[1024*1024];
        Map h = new HashMap();
        h.put("result", result);
        params.setResult(h);
        return params;
    }
    @Override
    public boolean nessary(DataContext params, GobrsAsyncSupport support) {
        return true;
    }
}
```
**åˆ›å»ºBService**
RPCè°ƒç”¨ æ•´ä¸ªä»»åŠ¡æµç¨‹æ¶ˆè€— 500ms

```java 
@Service
public class BService implements AsyncTask<DataContext, Map>, SerExector {

    @Override
    public void callback(boolean success, DataContext param, TaskResult<Map> workResult) {
        if (success) {
            System.out.println("BService æˆåŠŸ");
        } else {
            System.out.println("BService å¤±è´¥");
        }
    }

    @Override
    public Map task(DataContext params, GobrsAsyncSupport support) {
        try {
            Thread.sleep(500);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        HashMap hashMap = new HashMap();
        hashMap.put("result", "æˆ‘æ˜¯Bçš„ç»“æœ");
        return null;
    }

    @Override
    public boolean nessary(DataContext params, GobrsAsyncSupport support) {
        return true;
    }
}
```
**åˆ›å»ºEService**
RPCè°ƒç”¨ æ•´ä¸ªä»»åŠ¡æµç¨‹æ¶ˆè€— 500ms

```java  
@Service
public class EService implements AsyncTask<DataContext, DataContext>, ParaExector {

    @Override
    public void callback(boolean success, DataContext param, TaskResult<DataContext> workResult) {
        if (success) {
            System.out.println("EService æˆåŠŸ");
        } else {
            System.out.println("EService å¤±è´¥");
        }
    }
    @Override
    public DataContext task(DataContext params, GobrsAsyncSupport support) {
        try {
            // System.out.println(1/0);
            Thread.sleep(500);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        Map h = new HashMap();
        h.put("result", "æˆ‘æ˜¯EService çš„ ç»“æœ æ­å–œä½ æ‹¿åˆ°");
        params.setResult(h);
        return params;
    }

    @Override
    public boolean nessary(DataContext params, GobrsAsyncSupport support) {
        return true;
    }
}

```

**åˆ›å»ºFService**
æ¨¡æ‹Ÿå¤æ‚ä¸šåŠ¡å¤„ç†ï¼Œéœ€è¦æ¶ˆè€—1000ms


```java  
@Service
public class FService implements AsyncTask<DataContext, Map>, SerExector {
    @Override
    public void callback(boolean success, DataContext param, TaskResult<Map> workResult) {
        if (success) {
            System.out.println("FService æˆåŠŸ");
        } else {
            System.out.println("FService å¤±è´¥");
        }
    }

    @Override
    public Map task(DataContext params, GobrsAsyncSupport support) {
        try {
            DataContext result = getResult(support, EService.class);
            // å¤æ‚çš„ä¸šåŠ¡åœºæ™¯å¤„ç†
            System.out.println(JSONObject.toJSONString(result.getResult()));
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        return null;
    }

    @Override
    public boolean nessary(DataContext params, GobrsAsyncSupport support) {
        return true;
    }
}
```


### æ–¹æ¡ˆä¸€ ä½¿ç”¨æ™®é€šFutureæ–¹å¼å¼€å‘
çœ‹ä¸€çœ‹åˆ°ä½¿ç”¨æ™®é€šçš„å¼€å‘æ–¹å¼ï¼Œ ä»£ç è¾ƒä¸ºå¤æ‚ï¼Œè€Œä¸”è¿™è¿˜æ˜¯ä¸šåŠ¡æµç¨‹è¾ƒå°‘çš„ä»»åŠ¡æµç¨‹
```java 
 public void testFuture(HttpServletRequest httpServletRequest) {
        DataContext dataContext = new DataContext();
        dataContext.setHttpServletRequest(httpServletRequest);
        List<Future> list = new ArrayList<>();
        for (AsyncTask asyncTask : paraExectors) {
            Future<?> submit = gobrsThreadPoolExecutor.submit(() -> {
                asyncTask.task(dataContext, null);
            });
            list.add(submit);
        }
        for (Future future : list) {
            try {
                future.get();
            } catch (InterruptedException e) {
                e.printStackTrace();
            } catch (ExecutionException e) {
                e.printStackTrace();
            }
        }

        List<Future> ser = new ArrayList<>();
        for (AsyncTask asyncTask : serExectors) {
            Future<?> submit = gobrsThreadPoolExecutor.submit(() -> {
                asyncTask.task(dataContext, null);
            });
            ser.add(submit);
        }
        for (Future future : ser) {
            try {
                future.get();
            } catch (InterruptedException e) {
                e.printStackTrace();
            } catch (ExecutionException e) {
                e.printStackTrace();
            }
        }
    }
```


### æ–¹æ¡ˆäºŒ ä½¿ç”¨Gobrs-Async
ä½¿ç”¨æå…¶æ–¹ä¾¿
```java 
public void testGobrs(HttpServletRequest httpServletRequest) {
    DataContext dataContext = new DataContext();
    dataContext.setHttpServletRequest(httpServletRequest);
    AsyncResult asyncResult = taskFlow.taskFlow("test", dataContext, 100000);
}
```


## æµç¨‹åˆ†æ
æ–¹æ¡ˆä¸€ï¼š å…ˆæŠŠéœ€è¦ä¾èµ–çš„ä»»åŠ¡é€šè¿‡Future äº¤ç»™çº¿ç¨‹æ± æ‰§è¡Œã€‚å…ˆæ‰§è¡Œ <code>AService</code> å’Œ  <code>EService</code>

æ–¹æ¡ˆäºŒï¼š Eæ‰§è¡Œå®Œåä¼šç›´æ¥æ‰§è¡ŒFï¼Œè€Œä¸æ˜¯ç­‰å¾… Aæ‰§è¡Œå®Œ




## Jemeter æ£€æµ‹QPS

### æ–¹æ¡ˆä¸€
![jemeter-1](https://kevin-cloud-dubbo.oss-cn-beijing.aliyuncs.com/gobrs-async/jemeter-2.jpg)


### æ–¹æ¡ˆäºŒ
![jmeter-1](https://kevin-cloud-dubbo.oss-cn-beijing.aliyuncs.com/gobrs-async/jmeter-1.jpg)

## JProfilerç›‘æ§æ€§èƒ½


### æ–¹æ¡ˆä¸€

![profilder-1](https://kevin-cloud-dubbo.oss-cn-beijing.aliyuncs.com/gobrs-async/profilder-2.jpg)

### æ–¹æ¡ˆäºŒ
![profiler-1](https://kevin-cloud-dubbo.oss-cn-beijing.aliyuncs.com/gobrs-async/profiler-1.jpg)

## Jstat ç›‘æ§GCé¢‘æ¬¡


### æ–¹æ¡ˆä¸€
![jstate-1](https://kevin-cloud-dubbo.oss-cn-beijing.aliyuncs.com/gobrs-async/jstate-2.jpg)


### æ–¹æ¡ˆäºŒ
![jstat-1](https://kevin-cloud-dubbo.oss-cn-beijing.aliyuncs.com/gobrs-async/jstat-1.jpg)

## Console è®¡ç®—æ—¶é—´æˆ³

### æ–¹æ¡ˆä¸€
![console-1](https://kevin-cloud-dubbo.oss-cn-beijing.aliyuncs.com/gobrs-async/console-2.jpg)

### æ–¹æ¡ˆäºŒ
![console-1](https://kevin-cloud-dubbo.oss-cn-beijing.aliyuncs.com/gobrs-async/console-1.jpg)


## æ€»ç»“
**æ–¹æ¡ˆä¸€** çš„ç»“æœæ°¸è¿œä¸ä¼šä½äº 2Sä»¥ä¸‹ï¼Œå› ä¸º Future.get ä¼šé˜»å¡ä¸»çº¿ç¨‹

**æ–¹æ¡ˆäºŒ**  **Gobrs-Async** åˆ™ä¸ä¼šç­‰å¾… <code>AService</code> çš„è¿”å› å¯è¿…é€Ÿè°ƒç”¨ä¸‹æ¸¸ä»»åŠ¡ï¼Œæé«˜ç³»ç»Ÿ **QPS**

å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°åœ¨ä½¿ç”¨ Gobrs-Async å QPS ä»97 æå‡åˆ° 125ï¼Œ è¿™åªæ˜¯ç®€å•çš„ä»»åŠ¡æµç¨‹ï¼Œä»»åŠ¡è¶Šå¤æ‚é‚£ä¹ˆ Gobrs-Asyncçš„ä¼˜åŠ¿å°±è¶Šæ˜æ˜¾


<br/>

::: cardList

```yaml
- name: æŠ€æœ¯å°å±‹
  desc: å¤§é“è‡³ç®€ï¼ŒçŸ¥æ˜“è¡Œéš¾
  avatar: https://cdn.jsdelivr.net/gh/xugaoyi/image_store/blog/20200122153807.jpg # å¯é€‰
  link: https://docs.sizegang.cn/ # å¯é€‰
  bgColor: '#CBEAFA' # å¯é€‰ï¼Œé»˜è®¤var(--bodyBg)ã€‚é¢œè‰²å€¼æœ‰#å·æ—¶è¯·æ·»åŠ å•å¼•å·
  textColor: '#6854A1' # å¯é€‰ï¼Œé»˜è®¤var(--textColor)
- name: æ¶æ„å¸ˆå¿…ç»ä¹‹è·¯
  desc: 'ç²¾å“å­¦ä¹ èµ„æº'
  avatar: https://cdn.jsdelivr.net/gh/xaoxuu/assets@master/avatar/avatar.png
  link: https://learn.sizegang.cn
  bgColor: '#718971'
  textColor: '#fff'
- name: å¹³å‡¡çš„ä½ æˆ‘
  desc: å¿«ä¹è´­ç‰©ï¼Œäº«å—ç”Ÿæ´»
  avatar: https://reinness.com/avatar.png
  link: https://m.jd.com
  bgColor: '#FCDBA0'
  textColor: '#A05F2C'
```
:::
